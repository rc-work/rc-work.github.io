
<!DOCTYPE html>
<html>
	
<style>
body {

	background-image: url('images/cool-background.png');
	background-attachment: fixed;
	color: #333;
}

</style>

	<head>
		<title>HackTheBox SneakyMailer Writeup </title>
		
		<!-- link to main stylesheet -->
		<link rel="stylesheet" type="css/main.css">
	</head>
	<body>
		<div class="container">
    		<div class="blurb">
        		<h1>HTB SneakyMailer </h1>
				<p> 	
				<img src="images/sneaky/sneaky-header.PNG" alt="sneaky" class="inline"/> 							<br/> <br/> <br/>
				
				We start out with our usual nmap scan -  											<br/> <br/>
				<img src="images/sneaky/nmap.PNG" alt="nmap" class="inline"/>									<br/> <br/> <br/>
					
				Initially we can see we have a couple web servers and an email server. I went to checkout the web server 			<br/> 
				on port 80 and discovered a list of emails. 											<br/> <br/> 
				<img src="images/sneaky/sneaky-corp-home-page.PNG" alt="emails" class="inline"/> 						<br/> <br/> <br/>
					
				I saved these emails into a list and then continued on enumerating. I ran gobuster to pull out any additional domains or 	<br/>
				vhosts, and we find <b> dev.sneakcorp.htb </b>											<br/> <br/>
				<img src="images/sneaky/gob1.PNG" alt="emails" class="inline"/> 								<br/> <br/> <br/>
				<img src="images/sneaky/gob2.PNG" alt="emails" class="inline"/> 								<br/> <br/> <br/>
					
				Sadly it appeared to have the same info as the normal domain. I checked out the app on port 8080 next. 				<br/> <br/>
				<img src="images/sneaky/8080-app.PNG" alt="web app on port 8080" class="inline"/> 						<br/> <br/> <br/>
				
				Not much to see there so I moved onto the ftp server. FTP appeared to be a dead end since at this point as we don't have 	<br/>
				any creds and there is no guest access. Judging by the name of the box and the fact that we have an email list, I started 	<br/>
				thinking we have to phish a user. 												<br/> <br/>
					
				I opted to use a tool called swaks - <a href="https://github.com/jetmore/swaks">which you can checkout here</a> 		<br/> <br/>
				
				Our basic idea is just to get one of the users to click on our ip, and we should be able to see the connection 			<br/>
				in netcat and judge where to go from there. I sent out an email to everyone on the list we found earlier, with the 		<br/>
				simple contents of "Visit 8.8.8.8" where 8.8.8.8 would be my ip. 								<br/> <br/>
				<img src="images/sneaky/swaks.PNG" alt="swaks" class="inline"/> 								<br/> <br/> <br/>
					
				In our netcat window we see an http connection attempt with the users creds.  							<br/> <br/>
				<img src="images/sneaky/phished.PNG" alt="phished" class="inline"/> 								<br/> <br/> <br/>	
					
				After urldecoding the above password, we get 
				
				<br/><br/><br/> <code>
				Username: 	paulbyrd@sneakymailer.htb 		<br/>
				Password:	^(#J@SkFv2[%KhIxKk(Ju`hqcHl<:Ht 	<br/>
				</code>  <br/><br/><br/>
				
				With our new email creds, we should now be able to setup an email client and read through pauls emails. 			<br/>
				I setup Evolution, which you can download with a simple  									<br/><br/><br/>
				
				<code>
				apt-get install evolution
				</code> 															<br/><br/><br/>
					
				After installing evolution and setting it up with pauls creds, we are able to see 2 emails in pauls sent folder. 		<br/>
				The first is a set of credentials for the developer user 									<br/><br/>
				<img src="images/sneaky/smtp-creds.PNG" alt="pauls emails" class="inline"/> 							<br/><br/><br/>
					
				And the 2nd gives us a piece of information, telling us that all of the packages in pypi are ran and tested by 			<br/>
				the low user. This may come in handy  if we need to pivot to the low user. 							<br/> <br/>
				<img src="images/sneaky/smtp-info.PNG" alt="pauls emails" class="inline"/> 							<br/> <br/> <br/>
					
				Our cred list is now - 													
					
				<br/><br/><br/> <code>
				(smtp)							<br/>
				Username: 	paulbyrd@sneakymailer.htb 		<br/>
				Password:	^(#J@SkFv2[%KhIxKk(Ju`hqcHl<:Ht		<br/><br/>
				
				(user acct)						<br/>
				Username: 	developer				<br/>
				Password: 	m^AsY7vTKVT+dV1{WOU%@NaHkUAId3]C	<br/><br/>
				</code>							<br/><br/><br/>
					
				Now with developer creds, we are able to log into the ftp server. There is a /dev/ directory which we have access to,		<br/>
				that looks like the same directory that is served on <b> dev.sneakycorp.htb </b>. So in theory we should be able to drop 	<br/>
				a reverse shell in there, then trigger it on the webserver in order to send a reverse connection back to our machine. 		<br/><br/><br/>
					
				I opted to use the php reverse shell from pentest monkey - <a href="http://pentestmonkey.net/tools/web-shells/php-reverse-shell">which you can checkout here</a> <br/> <br/>
					
				After setting up my ip/port info, I uploaded to the ftp server - 								<br/> <br/>
				<img src="images/sneaky/ftp.PNG" alt="uploading rev shell over ftp" class="inline"/> 						<br/> <br/> <br/>
					
				And after visiting the page in our browser we receive a connection back to our netcat 						<br/> <br/>
				<img src="images/sneaky/low-priv.PNG" alt="foothold" class="inline"/> 								<br/> <br/> <br/> <br/>
					
				We are dropped in a user shell as www-data. We can su over to the developer user as well, but we are still unable to 		<br/>
				pull the user flag, as it is located in user low's directory. I started out by running the standard linenum script. It 		<br/>
				pulls out some creds from an open .htpasswd file for <b> pypi.sneakycorp.htb </b> 						<br/><br/>
				<img src="images/sneaky/pypi-creds.PNG" alt=".htpasswd creds" class="inline"/> 							<br/> <br/> <br/>
				
				Some further enumeration revealed this to be the port 8080 application that we were previously unable to see. 			<br/> <br/>
				<img src="images/sneaky/pypi-home-page.PNG" alt="port 8080 web app" class="inline"/> 						<br/> <br/> <br/>
					
				Remembering back to our 2nd email we discovered in pauls sent folder, <b>every package in here is executed by the low user</b>. <br/>
				So our gameplan from here is to figure out how to upload a malaicious package that low will then execute for us.		<br/>
				First step is to crack the hash from .htpasswd. We can determine the generic hash type from hash-identifier 			<br/> <br/>
				<img src="images/sneaky/pypi-creds2.PNG" alt="pypi" class="inline"/> 								<br/> <br/> <br/>
																  
				We can then find the actual hash type on the hashcat page <a href="https://hashcat.net/wiki/doku.php?id=example_hashes">which you can checkout here</a>, and then attempt to crack it 					<br/> <br/>
				<img src="images/sneaky/pypi-creds3.PNG" alt="pypi" class="inline"/> 								<br/> <br/> <br/>
				<img src="images/sneaky/pypi-creds4.PNG" alt="pypi" class="inline"/> 								<br/> <br/> <br/>
				
				Hashcat cracks it, and we can update our creds list  										<br/> <br/
					
				<br/><br/><br/> <code>
				(smtp)							<br/>
				Username: 	paulbyrd@sneakymailer.htb 		<br/>
				Password:	^(#J@SkFv2[%KhIxKk(Ju`hqcHl<:Ht		<br/><br/>
				
				(user acct)						<br/>
				Username: 	developer				<br/>
				Password: 	m^AsY7vTKVT+dV1{WOU%@NaHkUAId3]C	<br/><br/>
				
				(pypi creds)						<br/>
				username: 	pypi					<br/>
 				password:	soufianeelhaoui				<br/><br/>
				</code><br/><br/><br/>
																  
				With our newfound pypi creds in hand, we turn to the pypi documentation to figure out how to upload a package. 			<br/>
				There are 2 files we need to setup. Firstly, we need a .pypirc file, which tells the system where to get the packages		<br/>
				from and what creds to use. Secondly, we need a setup.py file which details what actions to perform to install it.		<br/><br/><br/>
					
				example .pypirc file from pypi docs												<br/><br/>
				<img src="images/sneaky/pypi-setup2.PNG" alt="pypi docs" class="inline"/>							<br/><br/><br/>
				
				example setup.py file from pypi docs												<br/><br/>
				<img src="images/sneaky/pypi-setup1.PNG" alt="pypi docs" class="inline"/>							<br/><br/><br/>
					
				The basic idea is that we build these on our host kali system, and then transfer them over to sneakymailer. We then		<br/>
				run the setup.py file which will contain our malicious code. I set these up on my system like so				<br/<br/>
					
				<img src="images/sneaky/setup-py.PNG" alt="setup.py" class="inline"/>								<br/><br/><br/>
				<img src="images/sneaky/pypirc.PNG" alt="pypirc" class="inline"/>								<br/><br/><br/>
					
				I transferred these two files over into the /tmp directory on sneakymailer, and then added the /tmp directory into my path with	<br/><br/><br/>
				
				<code>
				HOME=`pwd`
				</code>																<br/><br/><br/>
					
				
				I then started up my netcat listener and attempted to upload the package							<br/><br/>
				<img src="images/sneaky/pypi.PNG" alt="pypi package upload" class="inline"/>							<br/><br/><br/>
				
				It succeeded, so I checked my netcat listener											<br/><br/>
				<img src="images/sneaky/user-txt.PNG" alt="low priv shell" class="inline"/>							<br/><br/><br/>
				
				<b> We got user !! </b>														<br/><br/><br/>
				
				
				
					
				
			
			  	</p>
    		</div><!-- /.blurb -->
		<div class="blurb">	
		</div><!-- /.container -->
		
	</body>
</html>
